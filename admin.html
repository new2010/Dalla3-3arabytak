<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø¯Ù„Ø¹ Ø¹Ø±Ø¨ÙŠØªÙƒ</title>
    <link rel="stylesheet" href="assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        .admin-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .login-form { max-width: 400px; margin: 100px auto; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2em; font-weight: bold; color: #2563eb; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; background: none; }
        .tab.active { background: #2563eb; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px; border: 1px solid #ddd; text-align: right; }
        .data-table th { background: #f5f5f5; }
        .status-pending { color: #f59e0b; }
        .status-processing { color: #3b82f6; }
        .status-completed { color: #10b981; }
        .status-delivered { color: #059669; }
        .status-cancelled { color: #ef4444; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .admin-actions { display: flex; gap: 10px; }
        .admin-actions button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-edit { background: #f59e0b; color: white; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-update { background: #10b981; color: white; }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Login Form -->
        <div id="loginSection" class="login-form">
            <h2 style="text-align: center;">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù</h2>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©:</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <button type="submit" class="btn btn-primary btn-large">Ø¯Ø®ÙˆÙ„</button>
            </form>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" style="display: none;">
            <header class="admin-header" style="margin-bottom: 30px;">
                <h1>ğŸš— Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø¯Ù„Ø¹ Ø¹Ø±Ø¨ÙŠØªÙƒ</h1>
                <button onclick="logout()" class="btn btn-danger" style="float: left;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                <div style="clear: both;"></div>
            </header>

            <!-- Dashboard Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                    <div class="stat-number" id="totalOrders">0</div>
                </div>
                <div class="stat-card">
                    <h3>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
                    <div class="stat-number" id="todaySales">0 Ø¬Ù†ÙŠÙ‡</div>
                </div>
                <div class="stat-card">
                    <h3>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø±</h3>
                    <div class="stat-number" id="monthlySales">0 Ø¬Ù†ÙŠÙ‡</div>
                </div>
                <div class="stat-card">
                    <h3>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h3>
                    <div class="stat-number" id="activeProducts">0</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('products')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
                <button class="tab" onclick="showTab('orders')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
                <button class="tab" onclick="showTab('analytics')">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</button>
            </div>

            <!-- Products Tab -->
            <div id="productsTab" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>
                    <button class="btn btn-primary" onclick="showAddProductForm()">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</button>
                </div>

                <!-- Add/Edit Product Form -->
                <div id="productForm" class="form-container" style="display: none;">
                    <h4 id="formTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h4>
                    <form id="productFormElement">
                        <input type="hidden" id="productId">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="productName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *</label>
                                <input type="text" id="productName" required>
                            </div>
                            <div class="form-group">
                                <label for="productCategory">Ø§Ù„ÙØ¦Ø© *</label>
                                <select id="productCategory" required>
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>
                                    <option value="Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ©">Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ÙŠØ©</option>
                                    <option value="Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©">Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©</option>
                                    <option value="Ø¥Ø¶Ø§Ø¡Ø©">Ø¥Ø¶Ø§Ø¡Ø©</option>
                                    <option value="ØªÙ†Ø¸ÙŠÙ ÙˆØ¹Ù†Ø§ÙŠØ©">ØªÙ†Ø¸ÙŠÙ ÙˆØ¹Ù†Ø§ÙŠØ©</option>
                                    <option value="Ù‚Ø·Ø¹ ØºÙŠØ§Ø±">Ù‚Ø·Ø¹ ØºÙŠØ§Ø±</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="productPrice">Ø§Ù„Ø³Ø¹Ø± (Ø¬Ù†ÙŠÙ‡) *</label>
                                <input type="number" id="productPrice" required min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="productStock">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø© *</label>
                                <input type="number" id="productStock" required min="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="productImageDesc">ÙˆØµÙ Ø§Ù„ØµÙˆØ±Ø© *</label>
                            <input type="text" id="productImageDesc" required 
                                   placeholder="Ù…Ø«Ø§Ù„: ØµÙˆØ±Ø© Ø·Ù‚Ù… Ø¯ÙˆØ§Ø³Ø§Øª Ø¬Ù„Ø¯ Ø£Ø³ÙˆØ¯ Ù…Ø¹ Ø®ÙŠØ§Ø·Ø© Ø­Ù…Ø±Ø§Ø¡">
                        </div>
                        <div class="form-group">
                            <label for="productShortDesc">Ø§Ù„ÙˆØµÙ Ø§Ù„Ù…Ø®ØªØµØ±</label>
                            <input type="text" id="productShortDesc">
                        </div>
                        <div class="form-group">
                            <label for="productLongDesc">Ø§Ù„ÙˆØµÙ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</label>
                            <textarea id="productLongDesc" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="productTags">Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©</label>
                            <input type="text" id="productTags" placeholder="Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="productFeatured"> Ù…Ù†ØªØ¬ Ù…Ù…ÙŠØ²
                            </label>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="saveProductBtn">Ø­ÙØ¸</button>
                            <button type="button" class="btn btn-secondary" onclick="hideProductForm()">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </form>
                </div>

                <!-- Products List -->
                <div id="productsTable"></div>
            </div>

            <!-- Orders Tab -->
            <div id="ordersTab" class="tab-content">
                <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                <div id="ordersTable"></div>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsTab" class="tab-content">
                <h3>ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                <div id="analyticsContent">
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <h4>Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¨ÙŠØ¹Ø§Ù‹</h4>
                            <div id="topProducts"></div>
                        </div>
                        <div class="stat-card">
                            <h4>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</h4>
                            <div id="ordersByStatus"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="toast"></div>

    <script src="config.js"></script>
    <script src="assets/app.js"></script>
    <script>
        let adminKey = '';
        let isLoggedIn = false;
        let currentProducts = [];
        let currentOrders = [];

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            checkSession();
            initializeLoginForm();
        });

        // Check existing session
        function checkSession() {
            const savedAdminKey = sessionStorage.getItem('adminKey');
            if (savedAdminKey) {
                adminKey = savedAdminKey;
                verifySession();
            }
        }

        // Verify session with server
        async function verifySession() {
            try {
                const response = await fetch(`${API_BASE}?action=orders&adminKey=${adminKey}`);
                if (response.ok) {
                    isLoggedIn = true;
                    showAdminPanel();
                    loadDashboard();
                } else {
                    sessionStorage.removeItem('adminKey');
                }
            } catch (error) {
                sessionStorage.removeItem('adminKey');
            }
        }

        // Initialize login form
        function initializeLoginForm() {
            document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const password = document.getElementById('adminPassword').value;
                await attemptLogin(password);
            });
        }

        // Attempt admin login
        async function attemptLogin(password) {
            try {
                // Test admin key by fetching orders
                const response = await fetch(`${API_BASE}?action=orders&adminKey=${password}`);
                
                if (response.ok) {
                    adminKey = password;
                    isLoggedIn = true;
                    sessionStorage.setItem('adminKey', adminKey);
                    showAdminPanel();
                    loadDashboard();
                    showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                } else {
                    showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…', 'error');
            }
        }

        // Show admin panel
        function showAdminPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
        }

        // Logout
        function logout() {
            adminKey = '';
            isLoggedIn = false;
            sessionStorage.removeItem('adminKey');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                await Promise.all([
                    loadProducts(),
                    loadOrders(),
                    updateDashboardStats()
                ]);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            }
        }

        // Load products
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE}?action=products`);
                currentProducts = await response.json();
                displayProductsTable();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Load orders
        async function loadOrders() {
            try {
                const response = await fetch(`${API_BASE}?action=orders&adminKey=${adminKey}`);
                currentOrders = await response.json();
                displayOrdersTable();
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            document.getElementById('totalOrders').textContent = currentOrders.length;
            document.getElementById('activeProducts').textContent = currentProducts.length;

            // Calculate today's sales
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = currentOrders.filter(order => 
                order.created_at && order.created_at.startsWith(today)
            );
            const todaySales = todayOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            document.getElementById('todaySales').textContent = `${todaySales} Ø¬Ù†ÙŠÙ‡`;

            // Calculate monthly sales
            const currentMonth = new Date().toISOString().substring(0, 7); // YYYY-MM
            const monthlyOrders = currentOrders.filter(order => 
                order.created_at && order.created_at.startsWith(currentMonth)
            );
            const monthlySales = monthlyOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            document.getElementById('monthlySales').textContent = `${monthlySales} Ø¬Ù†ÙŠÙ‡`;
        }

        // Display products table
        function displayProductsTable() {
            const container = document.getElementById('productsTable');
            
            if (!currentProducts || currentProducts.length === 0) {
                container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</p>';
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„ÙØ¦Ø©</th>
                            <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            <th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th>
                            <th>Ù…Ù…ÙŠØ²</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentProducts.map(product => `
                            <tr>
                                <td>${product.name}</td>
                                <td>${product.category || '-'}</td>
                                <td>${product.price} Ø¬Ù†ÙŠÙ‡</td>
                                <td>${product.stock || 0}</td>
                                <td>${product.featured ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</td>
                                <td class="admin-actions">
                                    <button class="btn-edit" onclick="editProduct('${product.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                                    <button class="btn-delete" onclick="deleteProduct('${product.id}')">Ø­Ø°Ù</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Display orders table
        function displayOrdersTable() {
            const container = document.getElementById('ordersTable');
            
            if (!currentOrders || currentOrders.length === 0) {
                container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentOrders.map(order => `
                            <tr>
                                <td>${order.order_id}</td>
                                <td>${order.customer_name}</td>
                                <td>${order.phone}</td>
                                <td>${order.total} Ø¬Ù†ÙŠÙ‡</td>
                                <td class="status-${getStatusClass(order.status)}">
                                    ${order.status || 'Ù…Ø¹Ù„Ù‚'}
                                </td>
                                <td>${formatDate(order.created_at)}</td>
                                <td class="admin-actions">
                                    <select onchange="updateOrderStatus('${order.order_id}', this.value)">
                                        <option value="Ù…Ø¹Ù„Ù‚" ${order.status === 'Ù…Ø¹Ù„Ù‚' ? 'selected' : ''}>Ù…Ø¹Ù„Ù‚</option>
                                        <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ${order.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                        <option value="ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°" ${order.status === 'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'selected' : ''}>ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                        <option value="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" ${order.status === 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…' ? 'selected' : ''}>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
                                        <option value="Ù…Ù„ØºÙ‰" ${order.status === 'Ù…Ù„ØºÙ‰' ? 'selected' : ''}>Ù…Ù„ØºÙ‰</option>
                                    </select>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Show tab
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Load specific data if needed
            if (tabName === 'analytics') {
                loadAnalytics();
            }
        }

        // Show add product form
        function showAddProductForm() {
            document.getElementById('formTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('productFormElement').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productForm').style.display = 'block';
        }

        // Hide product form
        function hideProductForm() {
            document.getElementById('productForm').style.display = 'none';
        }

        // Edit product
        function editProduct(productId) {
            const product = currentProducts.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('formTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productPrice').value = product.price || '';
            document.getElementById('productStock').value = product.stock || '';
            document.getElementById('productImageDesc').value = product.image_desc || '';
            document.getElementById('productShortDesc').value = product.short_desc || '';
            document.getElementById('productLongDesc').value = product.long_desc || '';
            document.getElementById('productTags').value = product.tags || '';
            document.getElementById('productFeatured').checked = product.featured || false;
            
            document.getElementById('productForm').style.display = 'block';
        }

        // Delete product
        async function deleteProduct(productId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;

            try {
                const response = await fetch(`${API_BASE}?action=deleteProduct`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminKey, id: productId })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    loadProducts();
                } else {
                    showToast(result.error || 'ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'error');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'error');
            }
        }

        // Update order status
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`${API_BASE}?action=updateOrderStatus`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminKey, order_id: orderId, status: newStatus })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨', 'success');
                    loadOrders();
                } else {
                    showToast(result.error || 'ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'error');
            }
        }

        // Handle product form submission
        document.getElementById('productFormElement').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const isEdit = !!productId;
            
            const productData = {
                adminKey,
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                image_desc: document.getElementById('productImageDesc').value,
                short_desc: document.getElementById('productShortDesc').value,
                long_desc: document.getElementById('productLongDesc').value,
                tags: document.getElementById('productTags').value,
                featured: document.getElementById('productFeatured').checked
            };

            if (isEdit) {
                productData.id = productId;
            }

            try {
                const action = isEdit ? 'updateProduct' : 'addProduct';
                const response = await fetch(`${API_BASE}?action=${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                const result = await response.json();
                if (result.success) {
                    showToast(isEdit ? 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    hideProductForm();
                    loadProducts();
                } else {
                    showToast(result.error || 'ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬', 'error');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬', 'error');
            }
        });

        // Helper functions
        function getStatusClass(status) {
            const statusMap = {
                'Ù…Ø¹Ù„Ù‚': 'pending',
                'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°': 'processing', 
                'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°': 'completed',
                'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…': 'delivered',
                'Ù…Ù„ØºÙ‰': 'cancelled'
            };
            return statusMap[status] || 'pending';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('ar-EG');
        }

        function loadAnalytics() {
            // Simple analytics implementation
            const topProducts = {};
            currentOrders.forEach(order => {
                if (order.items_json) {
                    try {
                        const items = JSON.parse(order.items_json);
                        items.forEach(item => {
                            topProducts[item.name] = (topProducts[item.name] || 0) + item.qty;
                        });
                    } catch (e) {}
                }
            });

            const topProductsList = Object.entries(topProducts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .map(([name, qty]) => `<p>${name}: ${qty} Ù‚Ø·Ø¹Ø©</p>`)
                .join('');
            
            document.getElementById('topProducts').innerHTML = topProductsList || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª';

            const ordersByStatus = {};
            currentOrders.forEach(order => {
                const status = order.status || 'Ù…Ø¹Ù„Ù‚';
                ordersByStatus[status] = (ordersByStatus[status] || 0) + 1;
            });

            const statusList = Object.entries(ordersByStatus)
                .map(([status, count]) => `<p>${status}: ${count} Ø·Ù„Ø¨</p>`)
                .join('');
            
            document.getElementById('ordersByStatus').innerHTML = statusList || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª';
        }
    </script>
</body>
</html>