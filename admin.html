<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الإدارة - دلع عربيتك</title>
    <link rel="stylesheet" href="assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        .admin-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .login-form { max-width: 400px; margin: 100px auto; }
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2em; font-weight: bold; color: #2563eb; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; background: none; }
        .tab.active { background: #2563eb; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px; border: 1px solid #ddd; text-align: right; }
        .data-table th { background: #f5f5f5; }
        .status-pending { color: #f59e0b; }
        .status-processing { color: #3b82f6; }
        .status-completed { color: #10b981; }
        .status-delivered { color: #059669; }
        .status-cancelled { color: #ef4444; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .admin-actions { display: flex; gap: 10px; }
        .admin-actions button { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-edit { background: #f59e0b; color: white; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-update { background: #10b981; color: white; }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Login Form -->
        <div id="loginSection" class="login-form">
            <h2 style="text-align: center;">تسجيل دخول المشرف</h2>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label for="adminPassword">كلمة المرور الإدارية:</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <button type="submit" class="btn btn-primary btn-large">دخول</button>
            </form>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" style="display: none;">
            <header class="admin-header" style="margin-bottom: 30px;">
                <h1>🚗 لوحة إدارة دلع عربيتك</h1>
                <button onclick="logout()" class="btn btn-danger" style="float: left;">تسجيل خروج</button>
                <div style="clear: both;"></div>
            </header>

            <!-- Dashboard Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3>إجمالي الطلبات</h3>
                    <div class="stat-number" id="totalOrders">0</div>
                </div>
                <div class="stat-card">
                    <h3>مبيعات اليوم</h3>
                    <div class="stat-number" id="todaySales">0 جنيه</div>
                </div>
                <div class="stat-card">
                    <h3>مبيعات الشهر</h3>
                    <div class="stat-number" id="monthlySales">0 جنيه</div>
                </div>
                <div class="stat-card">
                    <h3>المنتجات النشطة</h3>
                    <div class="stat-number" id="activeProducts">0</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('products')">إدارة المنتجات</button>
                <button class="tab" onclick="showTab('orders')">إدارة الطلبات</button>
                <button class="tab" onclick="showTab('analytics')">التحليلات</button>
            </div>

            <!-- Products Tab -->
            <div id="productsTab" class="tab-content active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>إدارة المنتجات</h3>
                    <button class="btn btn-primary" onclick="showAddProductForm()">إضافة منتج جديد</button>
                </div>

                <!-- Add/Edit Product Form -->
                <div id="productForm" class="form-container" style="display: none;">
                    <h4 id="formTitle">إضافة منتج جديد</h4>
                    <form id="productFormElement">
                        <input type="hidden" id="productId">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="productName">اسم المنتج *</label>
                                <input type="text" id="productName" required>
                            </div>
                            <div class="form-group">
                                <label for="productCategory">الفئة *</label>
                                <select id="productCategory" required>
                                    <option value="">اختر الفئة</option>
                                    <option value="إكسسوارات داخلية">إكسسوارات داخلية</option>
                                    <option value="إكسسوارات خارجية">إكسسوارات خارجية</option>
                                    <option value="إضاءة">إضاءة</option>
                                    <option value="تنظيف وعناية">تنظيف وعناية</option>
                                    <option value="قطع غيار">قطع غيار</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="productPrice">السعر (جنيه) *</label>
                                <input type="number" id="productPrice" required min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label for="productStock">الكمية المتاحة *</label>
                                <input type="number" id="productStock" required min="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="productImageDesc">وصف الصورة *</label>
                            <input type="text" id="productImageDesc" required 
                                   placeholder="مثال: صورة طقم دواسات جلد أسود مع خياطة حمراء">
                        </div>
                        <div class="form-group">
                            <label for="productShortDesc">الوصف المختصر</label>
                            <input type="text" id="productShortDesc">
                        </div>
                        <div class="form-group">
                            <label for="productLongDesc">الوصف التفصيلي</label>
                            <textarea id="productLongDesc" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="productTags">الكلمات المفتاحية</label>
                            <input type="text" id="productTags" placeholder="مفصولة بفاصلة">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="productFeatured"> منتج مميز
                            </label>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="saveProductBtn">حفظ</button>
                            <button type="button" class="btn btn-secondary" onclick="hideProductForm()">إلغاء</button>
                        </div>
                    </form>
                </div>

                <!-- Products List -->
                <div id="productsTable"></div>
            </div>

            <!-- Orders Tab -->
            <div id="ordersTab" class="tab-content">
                <h3>إدارة الطلبات</h3>
                <div id="ordersTable"></div>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsTab" class="tab-content">
                <h3>تحليلات المبيعات</h3>
                <div id="analyticsContent">
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <h4>أكثر المنتجات مبيعاً</h4>
                            <div id="topProducts"></div>
                        </div>
                        <div class="stat-card">
                            <h4>الطلبات حسب الحالة</h4>
                            <div id="ordersByStatus"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="toast"></div>

    <script src="config.js"></script>
    <script src="assets/app.js"></script>
    <script>
        let adminKey = '';
        let isLoggedIn = false;
        let currentProducts = [];
        let currentOrders = [];

        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            checkSession();
            initializeLoginForm();
        });

        // Check existing session
        function checkSession() {
            const savedAdminKey = sessionStorage.getItem('adminKey');
            if (savedAdminKey) {
                adminKey = savedAdminKey;
                verifySession();
            }
        }

        // Verify session with server
        async function verifySession() {
            try {
                const response = await fetch(`${API_BASE}?action=orders&adminKey=${adminKey}`);
                if (response.ok) {
                    isLoggedIn = true;
                    showAdminPanel();
                    loadDashboard();
                } else {
                    sessionStorage.removeItem('adminKey');
                }
            } catch (error) {
                sessionStorage.removeItem('adminKey');
            }
        }

        // Initialize login form
        function initializeLoginForm() {
            document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const password = document.getElementById('adminPassword').value;
                await attemptLogin(password);
            });
        }

        // Attempt admin login
        async function attemptLogin(password) {
            try {
                // Test admin key by fetching orders
                const response = await fetch(`${API_BASE}?action=orders&adminKey=${password}`);
                
                if (response.ok) {
                    adminKey = password;
                    isLoggedIn = true;
                    sessionStorage.setItem('adminKey', adminKey);
                    showAdminPanel();
                    loadDashboard();
                    showToast('تم تسجيل الدخول بنجاح', 'success');
                } else {
                    showToast('كلمة المرور غير صحيحة', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('خطأ في الاتصال بالخادم', 'error');
            }
        }

        // Show admin panel
        function showAdminPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
        }

        // Logout
        function logout() {
            adminKey = '';
            isLoggedIn = false;
            sessionStorage.removeItem('adminKey');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminPassword').value = '';
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                await Promise.all([
                    loadProducts(),
                    loadOrders(),
                    updateDashboardStats()
                ]);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('خطأ في تحميل البيانات', 'error');
            }
        }

        // Load products
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE}?action=products`);
                currentProducts = await response.json();
                displayProductsTable();
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Load orders
        async function loadOrders() {
            try {
                const response = await fetch(`${API_BASE}?action=orders&adminKey=${adminKey}`);
                currentOrders = await response.json();
                displayOrdersTable();
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            document.getElementById('totalOrders').textContent = currentOrders.length;
            document.getElementById('activeProducts').textContent = currentProducts.length;

            // Calculate today's sales
            const today = new Date().toISOString().split('T')[0];
            const todayOrders = currentOrders.filter(order => 
                order.created_at && order.created_at.startsWith(today)
            );
            const todaySales = todayOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            document.getElementById('todaySales').textContent = `${todaySales} جنيه`;

            // Calculate monthly sales
            const currentMonth = new Date().toISOString().substring(0, 7); // YYYY-MM
            const monthlyOrders = currentOrders.filter(order => 
                order.created_at && order.created_at.startsWith(currentMonth)
            );
            const monthlySales = monthlyOrders.reduce((sum, order) => sum + (order.total || 0), 0);
            document.getElementById('monthlySales').textContent = `${monthlySales} جنيه`;
        }

        // Display products table
        function displayProductsTable() {
            const container = document.getElementById('productsTable');
            
            if (!currentProducts || currentProducts.length === 0) {
                container.innerHTML = '<p>لا توجد منتجات</p>';
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الفئة</th>
                            <th>السعر</th>
                            <th>المخزون</th>
                            <th>مميز</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentProducts.map(product => `
                            <tr>
                                <td>${product.name}</td>
                                <td>${product.category || '-'}</td>
                                <td>${product.price} جنيه</td>
                                <td>${product.stock || 0}</td>
                                <td>${product.featured ? 'نعم' : 'لا'}</td>
                                <td class="admin-actions">
                                    <button class="btn-edit" onclick="editProduct('${product.id}')">تعديل</button>
                                    <button class="btn-delete" onclick="deleteProduct('${product.id}')">حذف</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Display orders table
        function displayOrdersTable() {
            const container = document.getElementById('ordersTable');
            
            if (!currentOrders || currentOrders.length === 0) {
                container.innerHTML = '<p>لا توجد طلبات</p>';
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>رقم الطلب</th>
                            <th>اسم العميل</th>
                            <th>الهاتف</th>
                            <th>المجموع</th>
                            <th>الحالة</th>
                            <th>التاريخ</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentOrders.map(order => `
                            <tr>
                                <td>${order.order_id}</td>
                                <td>${order.customer_name}</td>
                                <td>${order.phone}</td>
                                <td>${order.total} جنيه</td>
                                <td class="status-${getStatusClass(order.status)}">
                                    ${order.status || 'معلق'}
                                </td>
                                <td>${formatDate(order.created_at)}</td>
                                <td class="admin-actions">
                                    <select onchange="updateOrderStatus('${order.order_id}', this.value)">
                                        <option value="معلق" ${order.status === 'معلق' ? 'selected' : ''}>معلق</option>
                                        <option value="قيد التنفيذ" ${order.status === 'قيد التنفيذ' ? 'selected' : ''}>قيد التنفيذ</option>
                                        <option value="تم التنفيذ" ${order.status === 'تم التنفيذ' ? 'selected' : ''}>تم التنفيذ</option>
                                        <option value="تم التسليم" ${order.status === 'تم التسليم' ? 'selected' : ''}>تم التسليم</option>
                                        <option value="ملغى" ${order.status === 'ملغى' ? 'selected' : ''}>ملغى</option>
                                    </select>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Show tab
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Load specific data if needed
            if (tabName === 'analytics') {
                loadAnalytics();
            }
        }

        // Show add product form
        function showAddProductForm() {
            document.getElementById('formTitle').textContent = 'إضافة منتج جديد';
            document.getElementById('productFormElement').reset();
            document.getElementById('productId').value = '';
            document.getElementById('productForm').style.display = 'block';
        }

        // Hide product form
        function hideProductForm() {
            document.getElementById('productForm').style.display = 'none';
        }

        // Edit product
        function editProduct(productId) {
            const product = currentProducts.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('formTitle').textContent = 'تعديل المنتج';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productPrice').value = product.price || '';
            document.getElementById('productStock').value = product.stock || '';
            document.getElementById('productImageDesc').value = product.image_desc || '';
            document.getElementById('productShortDesc').value = product.short_desc || '';
            document.getElementById('productLongDesc').value = product.long_desc || '';
            document.getElementById('productTags').value = product.tags || '';
            document.getElementById('productFeatured').checked = product.featured || false;
            
            document.getElementById('productForm').style.display = 'block';
        }

        // Delete product
        async function deleteProduct(productId) {
            if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;

            try {
                const response = await fetch(`${API_BASE}?action=deleteProduct`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminKey, id: productId })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('تم حذف المنتج بنجاح', 'success');
                    loadProducts();
                } else {
                    showToast(result.error || 'فشل في حذف المنتج', 'error');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                showToast('خطأ في حذف المنتج', 'error');
            }
        }

        // Update order status
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await fetch(`${API_BASE}?action=updateOrderStatus`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminKey, order_id: orderId, status: newStatus })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('تم تحديث حالة الطلب', 'success');
                    loadOrders();
                } else {
                    showToast(result.error || 'فشل في تحديث الحالة', 'error');
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                showToast('خطأ في تحديث الحالة', 'error');
            }
        }

        // Handle product form submission
        document.getElementById('productFormElement').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const productId = document.getElementById('productId').value;
            const isEdit = !!productId;
            
            const productData = {
                adminKey,
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                image_desc: document.getElementById('productImageDesc').value,
                short_desc: document.getElementById('productShortDesc').value,
                long_desc: document.getElementById('productLongDesc').value,
                tags: document.getElementById('productTags').value,
                featured: document.getElementById('productFeatured').checked
            };

            if (isEdit) {
                productData.id = productId;
            }

            try {
                const action = isEdit ? 'updateProduct' : 'addProduct';
                const response = await fetch(`${API_BASE}?action=${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                const result = await response.json();
                if (result.success) {
                    showToast(isEdit ? 'تم تحديث المنتج بنجاح' : 'تم إضافة المنتج بنجاح', 'success');
                    hideProductForm();
                    loadProducts();
                } else {
                    showToast(result.error || 'فشل في حفظ المنتج', 'error');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                showToast('خطأ في حفظ المنتج', 'error');
            }
        });

        // Helper functions
        function getStatusClass(status) {
            const statusMap = {
                'معلق': 'pending',
                'قيد التنفيذ': 'processing', 
                'تم التنفيذ': 'completed',
                'تم التسليم': 'delivered',
                'ملغى': 'cancelled'
            };
            return statusMap[status] || 'pending';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString('ar-EG');
        }

        function loadAnalytics() {
            // Simple analytics implementation
            const topProducts = {};
            currentOrders.forEach(order => {
                if (order.items_json) {
                    try {
                        const items = JSON.parse(order.items_json);
                        items.forEach(item => {
                            topProducts[item.name] = (topProducts[item.name] || 0) + item.qty;
                        });
                    } catch (e) {}
                }
            });

            const topProductsList = Object.entries(topProducts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .map(([name, qty]) => `<p>${name}: ${qty} قطعة</p>`)
                .join('');
            
            document.getElementById('topProducts').innerHTML = topProductsList || 'لا توجد بيانات';

            const ordersByStatus = {};
            currentOrders.forEach(order => {
                const status = order.status || 'معلق';
                ordersByStatus[status] = (ordersByStatus[status] || 0) + 1;
            });

            const statusList = Object.entries(ordersByStatus)
                .map(([status, count]) => `<p>${status}: ${count} طلب</p>`)
                .join('');
            
            document.getElementById('ordersByStatus').innerHTML = statusList || 'لا توجد بيانات';
        }
    </script>
</body>
</html>