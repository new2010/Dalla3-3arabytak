<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุณูุฉ ุงููุดุชุฑูุงุช - ุฏูุน ุนุฑุจูุชู</title>
    <link rel="stylesheet" href="assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="nav">
                <div class="logo">
                    <h1>๐ ุฏูุน ุนุฑุจูุชู</h1>
                </div>
                <div class="nav-links">
                    <a href="index.html">ุงูุฑุฆูุณูุฉ</a>
                    <a href="cart.html" class="cart-link active">
                        <span class="cart-icon">๐</span>
                        ุงูุณูุฉ <span id="cartCount" class="cart-count">0</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <div class="container">
            <a href="index.html">ุงูุฑุฆูุณูุฉ</a>
            <span>/</span>
            <span>ุณูุฉ ุงููุดุชุฑูุงุช</span>
        </div>
    </div>

    <!-- Cart Section -->
    <section class="cart-section">
        <div class="container">
            <h1 class="page-title">ุณูุฉ ุงููุดุชุฑูุงุช</h1>
            
            <!-- Empty Cart -->
            <div id="emptyCart" class="empty-cart">
                <div class="empty-cart-icon">๐</div>
                <h3>ุงูุณูุฉ ูุงุฑุบุฉ</h3>
                <p>ูู ุชูู ุจุฅุถุงูุฉ ุฃู ููุชุฌุงุช ููุณูุฉ ุจุนุฏ</p>
                <a href="index.html" class="btn btn-primary">ุชุตูุญ ุงูููุชุฌุงุช</a>
            </div>

            <!-- Cart Items -->
            <div id="cartContent" class="cart-content" style="display: none;">
                <div class="cart-items">
                    <div class="cart-header">
                        <h3>ุงูููุชุฌุงุช ุงููุถุงูุฉ</h3>
                        <button id="clearCartBtn" class="btn btn-danger" onclick="clearCart()">
                            ุฅูุฑุงุบ ุงูุณูุฉ
                        </button>
                    </div>
                    <div id="cartItemsList" class="cart-items-list"></div>
                </div>

                <!-- Order Summary -->
                <div class="order-summary">
                    <div class="summary-card">
                        <h3>ููุฎุต ุงูุทูุจ</h3>
                        <div class="summary-line">
                            <span>ุงููุฌููุน ุงููุฑุนู:</span>
                            <span id="subtotal">0 ุฌููู</span>
                        </div>
                        <div class="summary-line">
                            <span>ุงูุดุญู:</span>
                            <span id="shippingCost">50 ุฌููู</span>
                        </div>
                        <div class="summary-line discount" id="discountLine" style="display: none;">
                            <span>ุฎุตู ุงูุดุญู ุงููุฌุงูู:</span>
                            <span id="discount">-50 ุฌููู</span>
                        </div>
                        <hr>
                        <div class="summary-line total">
                            <span><strong>ุงููุฌููุน ุงูุฅุฌูุงูู:</strong></span>
                            <span id="total"><strong>0 ุฌููู</strong></span>
                        </div>
                        <p class="free-shipping-notice" id="freeShippingNotice"></p>
                    </div>
                </div>

                <!-- Checkout Form -->
                <div class="checkout-section">
                    <h3>ูุนูููุงุช ุงูุทูุจ</h3>
                    <form id="checkoutForm" class="checkout-form">
                        <div class="form-group">
                            <label for="customerName">ุงูุงุณู ุงููุงูู *</label>
                            <input type="text" id="customerName" name="customerName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">ุฑูู ุงููุงุชู *</label>
                            <input type="tel" id="phone" name="phone" required 
                                   pattern="01[0-9]{9}" placeholder="01xxxxxxxxx">
                        </div>
                        
                        <div class="form-group">
                            <label for="address">ุงูุนููุงู ุงูุชูุตููู *</label>
                            <textarea id="address" name="address" required rows="3" 
                                    placeholder="ุงูุดุงุฑุน - ุงูููุทูุฉ - ุงููุญุงูุธุฉ"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="shippingType">ููุน ุงูุดุญู</label>
                            <select id="shippingType" name="shippingType">
                                <option value="standard">ุดุญู ุนุงุฏู (2-3 ุฃูุงู) - 50 ุฌููู</option>
                                <option value="express">ุดุญู ุณุฑูุน (24 ุณุงุนุฉ) - 100 ุฌููู</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="notes">ููุงุญุธุงุช (ุงุฎุชูุงุฑู)</label>
                            <textarea id="notes" name="notes" rows="2" 
                                    placeholder="ุฃู ููุงุญุธุงุช ุฎุงุตุฉ ุจุงูุทูุจ..."></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary btn-large" id="submitOrderBtn">
                                <span id="submitBtnText">ุชุฃููุฏ ุงูุทูุจ</span>
                                <span id="submitBtnSpinner" class="btn-spinner" style="display: none;">โณ</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Order Success -->
            <div id="orderSuccess" class="order-success" style="display: none;">
                <div class="success-icon">โ</div>
                <h3>ุชู ุฅุฑุณุงู ุทูุจู ุจูุฌุงุญ!</h3>
                <p>ุฑูู ุงูุทูุจ: <strong id="orderNumber"></strong></p>
                <p>ุณูุชู ุงูุชูุงุตู ูุนู ุฎูุงู 24 ุณุงุนุฉ ูุชุฃููุฏ ุงูุทูุจ</p>
                <div class="success-actions">
                    <a href="index.html" class="btn btn-primary">ุงูุนูุฏุฉ ููุชุณูู</a>
                    <button onclick="printOrderDetails()" class="btn btn-secondary">ุทุจุงุนุฉ ุชูุงุตูู ุงูุทูุจ</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>ุฏูุน ุนุฑุจูุชู</h3>
                    <p>ุฃูุถู ูุชุฌุฑ ูุฅูุณุณูุงุฑุงุช ุงูุณูุงุฑุงุช ูู ูุตุฑ</p>
                </div>
                <div class="footer-section">
                    <h4>ุฑูุงุจุท ุณุฑูุนุฉ</h4>
                    <ul>
                        <li><a href="index.html">ุงูุฑุฆูุณูุฉ</a></li>
                        <li><a href="cart.html">ุงูุณูุฉ</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>ุชูุงุตู ูุนูุง</h4>
                    <p>๐ 01234567890</p>
                    <p>๐ง info@dalewcarabitak.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 ุฏูุน ุนุฑุจูุชู. ุฌููุน ุงูุญููู ูุญููุธุฉ.</p>
            </div>
        </div>
    </footer>

    <!-- Notification Toast -->
    <div id="toast" class="toast"></div>

    <script src="config.js"></script>
    <script src="assets/app.js"></script>
    <script>
        let cartItems = [];
        let lastOrderId = '';

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadCart();
            updateCartDisplay();
            initializeCheckoutForm();
        });

        // Load cart from localStorage
        function loadCart() {
            const savedCart = localStorage.getItem('cart');
            if (savedCart) {
                try {
                    cartItems = JSON.parse(savedCart);
                } catch (error) {
                    console.error('Error parsing cart data:', error);
                    cartItems = [];
                }
            }
            updateCartCount();
        }

        // Update cart display
        function updateCartDisplay() {
            if (cartItems.length === 0) {
                document.getElementById('emptyCart').style.display = 'block';
                document.getElementById('cartContent').style.display = 'none';
                return;
            }

            document.getElementById('emptyCart').style.display = 'none';
            document.getElementById('cartContent').style.display = 'block';
            
            displayCartItems();
            updateOrderSummary();
        }

        // Display cart items
        function displayCartItems() {
            const container = document.getElementById('cartItemsList');
            
            container.innerHTML = cartItems.map((item, index) => `
                <div class="cart-item" data-index="${index}">
                    <div class="item-info">
                        <h4 class="item-name">${item.name}</h4>
                        <p class="item-price">${item.price} ${STORE_CONFIG.currency}</p>
                    </div>
                    <div class="quantity-controls">
                        <button onclick="updateItemQuantity(${index}, -1)">-</button>
                        <span class="quantity">${item.quantity}</span>
                        <button onclick="updateItemQuantity(${index}, 1)">+</button>
                    </div>
                    <div class="item-total">
                        ${item.price * item.quantity} ${STORE_CONFIG.currency}
                    </div>
                    <button class="remove-item" onclick="removeItem(${index})">๐๏ธ</button>
                </div>
            `).join('');
        }

        // Update item quantity
        function updateItemQuantity(index, delta) {
            if (cartItems[index]) {
                const newQuantity = cartItems[index].quantity + delta;
                if (newQuantity <= 0) {
                    removeItem(index);
                } else if (newQuantity <= 10) {
                    cartItems[index].quantity = newQuantity;
                    saveCart();
                    updateCartDisplay();
                }
            }
        }

        // Remove item from cart
        function removeItem(index) {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูููุชุฌ ูู ุงูุณูุฉุ')) {
                cartItems.splice(index, 1);
                saveCart();
                updateCartDisplay();
                showToast('ุชู ุญุฐู ุงูููุชุฌ ูู ุงูุณูุฉ');
            }
        }

        // Clear entire cart
        function clearCart() {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅูุฑุงุบ ุงูุณูุฉ ุจุงููุงููุ')) {
                cartItems = [];
                saveCart();
                updateCartDisplay();
                showToast('ุชู ุฅูุฑุงุบ ุงูุณูุฉ');
            }
        }

        // Update order summary
        function updateOrderSummary() {
            const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shippingType = document.getElementById('shippingType').value;
            let shippingCost = shippingType === 'express' ? 100 : STORE_CONFIG.shippingCost;
            
            // Free shipping for orders above threshold
            const isFreeShipping = subtotal >= STORE_CONFIG.freeShippingThreshold;
            if (isFreeShipping && shippingType === 'standard') {
                shippingCost = 0;
            }
            
            const total = subtotal + shippingCost;
            
            // Update display
            document.getElementById('subtotal').textContent = `${subtotal} ${STORE_CONFIG.currency}`;
            document.getElementById('shippingCost').textContent = `${shippingCost} ${STORE_CONFIG.currency}`;
            document.getElementById('total').querySelector('strong').textContent = `${total} ${STORE_CONFIG.currency}`;
            
            // Show/hide discount line
            const discountLine = document.getElementById('discountLine');
            if (isFreeShipping && shippingType === 'standard' && subtotal >= STORE_CONFIG.freeShippingThreshold) {
                discountLine.style.display = 'flex';
                document.getElementById('discount').textContent = `-${STORE_CONFIG.shippingCost} ${STORE_CONFIG.currency}`;
            } else {
                discountLine.style.display = 'none';
            }
            
            // Update free shipping notice
            const freeShippingNotice = document.getElementById('freeShippingNotice');
            if (subtotal < STORE_CONFIG.freeShippingThreshold) {
                const remaining = STORE_CONFIG.freeShippingThreshold - subtotal;
                freeShippingNotice.textContent = `ุฃุถู ${remaining} ${STORE_CONFIG.currency} ุฃุฎุฑู ููุญุตูู ุนูู ุดุญู ูุฌุงูู!`;
                freeShippingNotice.style.display = 'block';
            } else {
                freeShippingNotice.textContent = '๐ ุชูุงูููุง! ุญุตูุช ุนูู ุดุญู ูุฌุงูู';
                freeShippingNotice.style.display = 'block';
            }
        }

        // Initialize checkout form
        function initializeCheckoutForm() {
            const form = document.getElementById('checkoutForm');
            const shippingSelect = document.getElementById('shippingType');
            
            // Update shipping cost when selection changes
            shippingSelect.addEventListener('change', updateOrderSummary);
            
            // Handle form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (cartItems.length === 0) {
                    showToast('ุงูุณูุฉ ูุงุฑุบุฉ', 'error');
                    return;
                }
                
                const formData = new FormData(form);
                const orderData = {
                    customer_name: formData.get('customerName'),
                    phone: formData.get('phone'),
                    address: formData.get('address'),
                    shipping_type: formData.get('shippingType'),
                    notes: formData.get('notes') || '',
                    items: cartItems.map(item => ({
                        product_id: item.id,
                        name: item.name,
                        price: item.price,
                        qty: item.quantity
                    }))
                };
                
                // Calculate totals
                const subtotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                let shippingCost = orderData.shipping_type === 'express' ? 100 : STORE_CONFIG.shippingCost;
                
                if (subtotal >= STORE_CONFIG.freeShippingThreshold && orderData.shipping_type === 'standard') {
                    shippingCost = 0;
                }
                
                orderData.subtotal = subtotal;
                orderData.shipping = shippingCost;
                orderData.total = subtotal + shippingCost;
                
                await submitOrder(orderData);
            });
        }

        // Submit order to API
        async function submitOrder(orderData) {
            const submitBtn = document.getElementById('submitOrderBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const submitBtnSpinner = document.getElementById('submitBtnSpinner');
            
            try {
                // Show loading state
                submitBtn.disabled = true;
                submitBtnText.style.display = 'none';
                submitBtnSpinner.style.display = 'inline';
                
                const response = await fetch(`${API_BASE}?action=order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });
                
                const result = await response.json();
                
                if (result.success && result.order_id) {
                    // Clear cart and show success
                    cartItems = [];
                    saveCart();
                    lastOrderId = result.order_id;
                    showOrderSuccess(result.order_id);
                } else {
                    throw new Error(result.error || 'ูุดู ูู ุฅุฑุณุงู ุงูุทูุจ');
                }
                
            } catch (error) {
                console.error('Error submitting order:', error);
                showToast('ูุดู ูู ุฅุฑุณุงู ุงูุทูุจ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.', 'error');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtnText.style.display = 'inline';
                submitBtnSpinner.style.display = 'none';
            }
        }

        // Show order success message
        function showOrderSuccess(orderId) {
            document.getElementById('cartContent').style.display = 'none';
            document.getElementById('emptyCart').style.display = 'none';
            document.getElementById('orderSuccess').style.display = 'block';
            document.getElementById('orderNumber').textContent = orderId;
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Print order details
        function printOrderDetails() {
            window.print();
        }

        // Save cart to localStorage
        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cartItems));
            updateCartCount();
        }
    </script>
</body>
</html>